<!DOCTYPE html>
<html>

<head>
    <title>CDC Vaccination WDC</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-4.0.latest.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <h1>CDC Vaccination Data Connector</h1>
    <div id="wdcContainer">
        <button id="connectButton">Connect to CDC Vaccination Data</button>
    </div>

    <script>
        (function () {
            var myConnector = tableau.makeConnector();

            myConnector.getSchema = function (schemaCallback) {
                // Define your schema here (columns and their data types)
                var schema = [
                    {
                        id: "date",
                        dataType: tableau.dataTypeEnum.date
                    },
                    {
                        id: "total_doses_administered",
                        dataType: tableau.dataTypeEnum.int
                    },
                    // Add more columns based on the actual structure of the data
                ];

                var tableInfo = {
                    id: "cdcVaccinationData",
                    alias: "CDC Vaccination Data",
                    columns: schema
                };

                schemaCallback([tableInfo]);
            };

            myConnector.getData = function (table, doneCallback) {
                // Make an AJAX request to fetch data from the CDC vaccination data URL
                $.ajax({
                    url: "https://data.cdc.gov/api/views/hfr9-rurv/rows.json?accessType=DOWNLOAD",
                    dataType: "json",
                    success: function (data) {
                        var tableData = [];

                        // Process and format the API response into tableData
                        // Assuming the structure of the data is { date: ..., total_doses_administered: ... }
                        data.data.forEach(function (row) {
                            tableData.push({
                                date: new Date(row.date), // Assuming 'date' is a string representing a date
                                total_doses_administered: row.total_doses_administered,
                                // Add more fields based on the actual structure of the data
                            });
                        });

                        table.appendRows(tableData);
                        doneCallback();
                    }
                });
            };

            tableau.registerConnector(myConnector);

            $(document).ready(function () {
                $("#connectButton").click(function () {
                    tableau.connectionName = "CDC Vaccination Data";
                    tableau.submit();
                });
            });
        })();
    </script>
</body>

</html>
